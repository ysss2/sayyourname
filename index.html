<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SAYYOURNAME</title>
<style>
/* ==== í°íŠ¸ ==== */
@font-face{
  font-family:"OnulDanjo";
  src:url("./OnulDanjo-Regular.otf") format("opentype");
  font-display:swap;
}
@font-face{
  font-family:"WingdingsCustom";
  src:url("./Wingdings.ttf") format("truetype");
  font-display:swap;
}

/* ==== ë² ì´ìŠ¤ ==== */
html,body{
  height:100%; margin:0; background:#000; overflow:hidden;
  font-family:"OnulDanjo", Arial, sans-serif; color:#000;
}

/* ==== ì¤Œì¸ì•„ì›ƒ ë°°ê²½ ==== */
.bg-rings{
  position:fixed; inset:0; display:flex; justify-content:center; align-items:center;
  z-index:0; pointer-events:none;
}
.bg-rings svg{ width:100vmin; height:100vmin; overflow:visible; }
.ring{ transform-box:fill-box; transform-origin:50% 50%; }
@keyframes spinZoom-cw{0%{transform:rotate(0) scale(1)}50%{transform:rotate(180deg) scale(1.5)}100%{transform:rotate(360deg) scale(1)}}
@keyframes spinZoom-ccw{0%{transform:rotate(0) scale(1)}50%{transform:rotate(-180deg) scale(1.5)}100%{transform:rotate(-360deg) scale(1)}}
.r1{animation:spinZoom-cw 12s ease-in-out infinite;}
.r2{animation:spinZoom-ccw 10s ease-in-out infinite;}
.r3{animation:spinZoom-cw 8s ease-in-out infinite;}
.r4{animation:spinZoom-ccw 6s ease-in-out infinite;}

/* ==== ì‹œíŠ¸ ==== */
.sheet-wrap{
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  z-index:2; overflow:auto; max-height:85vh; border:1px solid #000; background:transparent;
  scroll-behavior:smooth;
}
/* ìŠ¤í¬ë¡¤ ìµœì†Œ ë…¸ì¶œ */
.sheet-wrap::-webkit-scrollbar{width:6px;height:6px}
.sheet-wrap::-webkit-scrollbar-thumb{background:rgba(255,255,255,.25);border-radius:4px;transition:background .2s}
.sheet-wrap::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.5)}
.sheet-wrap::-webkit-scrollbar-track{background:transparent}
.sheet-wrap{scrollbar-width:thin; scrollbar-color:rgba(255,255,255,.25) transparent;}

table.sheet{
  border-collapse:collapse; border:1px solid #000; table-layout:fixed; font-size:13px;
  font-family:"OnulDanjo","Noto Sans KR",sans-serif; color:#000;
}
.sheet th,.sheet td{
  border:1px solid #000; height:28px; text-align:center; vertical-align:middle; transition:background .25s ease;
  font-weight:400; line-height:1.35; letter-spacing:.01em;
}
.sheet th:first-child,.sheet td:first-child{
  width:140px; text-align:left; padding-left:8px; font-weight:500; letter-spacing:0;
}
.sheet th:not(:first-child),.sheet td:not(:first-child){ width:38px; }

/* ==== ììŒ(ìœ™ë”©ìŠ¤) ==== */
.icon{
  display:inline-flex; justify-content:center; align-items:center;
  width:22px; height:22px; border:1.4px dotted #000; border-radius:50%;
  font-family:"WingdingsCustom","Wingdings",sans-serif; font-size:18px; line-height:1; user-select:none;
  opacity:0; transform:scale(.5); transition:all .4s ease;
}
.icon.show{ opacity:1; transform:scale(1); }

/* ==== ëª¨ìŒ(ë™ì¼ ì›í˜•/í¬ê¸°) ==== */
.vowel{
  display:inline-block; background:#000; border-radius:50%;
  width:12px; height:12px; transform:none; opacity:0; transition:opacity .25s ease;
}
.vowel.show{ opacity:1; }

/* ==== ë²„íŠ¼/íŒíŠ¸ ==== */
.print-bar{position:fixed; left:12px; bottom:12px; z-index:3; display:flex; gap:8px;}
.btn{cursor:pointer; background:#fff; color:#000; border-radius:8px; padding:6px 10px; border:none; font-size:12px;}
.hint{position:fixed; left:12px; bottom:48px; font-size:12px; color:#ccc; z-index:3}

/* ==== ì„¤ëª… ë²„íŠ¼ & íŒì—… ==== */
.info-btn{
  position:fixed; right:16px; bottom:16px; z-index:5;
  background:#fff; color:#000; border:none; border-radius:20px; padding:6px 12px; font-size:13px;
  cursor:pointer; opacity:.8; transition:opacity .2s ease;
}
.info-btn:hover{opacity:1}
.info-modal{
  position:fixed; inset:0; background:rgba(0,0,0,.55);
  display:none; justify-content:center; align-items:center; z-index:10;
}
.info-content{
  position:relative; background:#fff; color:#111;
  max-width:250x; padding:24px 28px; border-radius:16px; box-shadow:0 8px 20px rgba(0,0,0,.25);
  font-family:"OnulDanjo","Noto Sans KR",sans-serif; line-height:1.6; animation:fadeIn .4s ease;
}
.info-content h2{margin:0 0 8px; font-size:18px; font-weight:600}
.info-content p{font-size:13.5px; margin:0}
.info-content .close{position:absolute; right:22px; top:18px; font-size:20px; cursor:pointer; color:#333}
@keyframes fadeIn{from{opacity:0; transform:translateY(10px)}to{opacity:1; transform:none}}

/* ==== ì¸ì‡„/PDF ==== */
@media print{
  @page{ size:A4 portrait; margin:10mm }
  *{-webkit-print-color-adjust:exact; print-color-adjust:exact}
  .bg-rings,.print-bar,.hint,.info-btn,.info-modal{ display:none !important }
  html,body{ background:#fff !important; color:#000 !important; overflow:visible !important; height:auto }
  .sheet-wrap{ position:static !important; transform:none !important; max-height:none !important; overflow:visible !important; width:100% !important; border:0 }
  table.sheet{ width:100% !important; table-layout:fixed; font-size:10pt; border:1px solid #000; color:#000 }
  .sheet th,.sheet td{ border:1px solid #000; height:8mm; padding:0 }
  .icon,.vowel{ opacity:1 !important; transform:none !important }
}
</style>
</head>
<body>

<!-- ==== ë°°ê²½ ==== -->
<div class="bg-rings">
  <svg viewBox="0 0 1000 1000" preserveAspectRatio="xMidYMid meet">
    <circle class="ring r1" cx="500" cy="500" r="500" fill="none" stroke="#12b7ff" stroke-width="260"/>
    <circle class="ring r2" cx="500" cy="500" r="370" fill="none" stroke="#e31d93" stroke-width="240"/>
    <circle class="ring r3" cx="500" cy="500" r="250" fill="none" stroke="#078f47" stroke-width="220"/>
    <circle class="ring r4" cx="500" cy="500" r="130" fill="none" stroke="#ffe933" stroke-width="200"/>
    <circle cx="500" cy="500" r="70" fill="#000"/>
  </svg>
</div>

<!-- ==== ì‹œíŠ¸ ==== -->
<div class="sheet-wrap" id="sheetWrap">
  <table class="sheet" id="sheet">
    <thead><tr><th>NAME</th></tr></thead>
    <tbody id="sheetBody"></tbody>
  </table>
</div>

<div class="hint" id="hint">ğŸ§ í™œì„±í™”</div>

<!-- ==== ì»¨íŠ¸ë¡¤ ==== -->
<div class="print-bar">
  <button id="startBtn" class="btn">ğŸ™</button>
  <button id="printBtn" class="btn">ğŸ“„PDF</button>
</div>

<!-- ==== ì„¤ëª… ë²„íŠ¼ & íŒì—… ==== -->
<button id="infoBtn" class="info-btn">â„¹ï¸ ì„¤ëª…</button>
<div id="infoModal" class="info-modal">
  <div class="info-content">
    <span class="close">&times;</span>
    <p>
        ì´ë¦„ë“¤ì˜ ìƒê¹€ìƒˆëŠ” ì™„ë²½íˆ ë™ë“±í•œ ê²ƒì´ ì—†ëŠ”ë° ì–´ë”˜ê°€ ê°€ë§Œíˆ ë°”ë¼ë³´ê³  ìˆìœ¼ë©´ ëª¨ë‘ í•˜ë‚˜ë¡œ ëŠê»´ì§„ë‹¤.
        <p>
        â‘´	ì´ë¦„ì€ ì„œë¡œ ìƒìƒë˜ì–´ì•¼ í•œë‹¤ëŠ” ê²ƒ.
        â‘µ	ì´ë¦„ì˜ ì²«ê¸€ì, ì¤‘ê°„ ê¸€ì, ëê¸€ìëŠ” ì—°ê²°ë¼ ìˆë‹¤. 
        â‘¶	ì†Œë¦¬ëŠ” ì£¼ë³€ì— ì˜í–¥ì„ ì¤€ë‹¤. ì¢‹ì€ ì´ë¦„ì„ ë¶€ë¥¼ ìˆ˜ë¡ ê·¸ ì‚¬ëŒì˜ ìš´ìˆ˜ëŠ” ì¢‹ì•„ì§€ê³ , ë‚˜ìœ ì´ë¦„ì„ ë¶€ë¥¼ ìˆ˜ë¡ ê·¸ ì‚¬ëŒì˜ ìš´ìˆ˜ëŠ” ë‚˜ë¹ ì§„ë‹¤.
        </p>
        <p>
        ì†Œë¦¬ ë‚´ì–´ ê³µê¸°ë¥¼ ì§„ë™ì‹œì¼œì•¼ë§Œ íš¨ê³¼ê°€ ë‚˜íƒ€ë‚œë‹¤.
        ë‹¤ì‹œ ë§í•´ ì´ë¦„ì„ ë¶ˆëŸ¬ì•¼ë§Œ ê·¸ íš¨ë ¥ì´ ìƒê¸´ë‹¤ëŠ” ëœ»ì´ë‹¤.
        ì´ë¦„ì´ ë‹¨ìˆœí•œ í‘œì‹ì´ ì•„ë‹ˆë¼, ë°œí™”ë˜ëŠ” ìˆœê°„ì— ë¹„ë¡œì†Œ ìƒëª…ë ¥ì„ ì–»ëŠ” ì–¸ì–´ì  ì¡´ì¬ì„ì„ ì‹œì‚¬í•œë‹¤.
    </p>
    <p>
        í˜¸ëª…ì„ í†µí•´ í˜¸ì¶œëœ ì´ë¦„ë“¤ì€ í™”ë©´ ì† ì‹œíŠ¸ ìœ„ì— í•˜ë‚˜ì”© ê¸°ë¡ë˜ê³ , ê·¸ ì´ë¦„ì˜ ì†Œë¦¬ì™€ ë¦¬ë“¬ì€ ìš¸ë¦¼ì´ ëœë‹¤.
        ë¶ˆì™„ì „í•œ í˜¸ëª…ê³¼ ë°˜ë³µë˜ëŠ” ë¶€ë¦„ ì†ì—ì„œ, ë‚˜ì™€ ë„ˆ, ì´ë¦„ë“¤ì˜ í”ì ì„ ê¸°ë¡í•œë‹¤.
    </p>
<p>
        ì´ë¦„ì„ í˜¸ëª…í•˜ì‹œì˜¤.
    </p>
    </p>
  </div>
</div>

<script>
/* ===== ì‘í’ˆ ì„¤ëª… íŒì—… ===== */
const infoBtn=document.getElementById('infoBtn');
const infoModal=document.getElementById('infoModal');
const close=document.querySelector('.info-content .close');
infoBtn.onclick=()=>{infoModal.style.display='flex'};
close.onclick=()=>{infoModal.style.display='none'};
infoModal.onclick=e=>{ if(e.target===infoModal) infoModal.style.display='none' };

/* ===== ì‹œíŠ¸ ì»¬ëŸ¼: ì‹œì‘ ì‹œ 1~18 ë¯¸ë¦¬ ë…¸ì¶œ ===== */
const MAX_NAME_LEN=6, MAX_PARTS_PER_SYLL=3, MAX_COLS=MAX_NAME_LEN*MAX_PARTS_PER_SYLL;

const MAP={"ã„±":"1","ã„´":"2","ã„·":"9","ã„¹":"0","ã…":"9","ã…‚":"0","ã……":"7","ã…‡":"8","ã…ˆ":"5","ã…Š":"6","ã…‹":"4","ã…Œ":"3","ã…":"5","ã…":"6"};
const RING_COLORS=["#12b7ff","#e31d93","#078f47","#ffe933"];
const sheet=document.getElementById('sheet');
const sheetBody=document.getElementById('sheetBody');
const hint=document.getElementById('hint');

function initSheetColumns(n){
  const header=sheet.querySelector('thead tr');
  const cur=header.children.length-1;
  for(let i=cur+1;i<=n;i++){
    const th=document.createElement('th'); th.textContent=i; header.appendChild(th);
  }
}

function ensureColumns(count){
  const header=sheet.querySelector('thead tr');
  const current=header.children.length-1;
  if(count>current){
    for(let i=current+1;i<=count;i++){
      const th=document.createElement('th'); th.textContent=i; header.appendChild(th);
      sheetBody.querySelectorAll('tr').forEach(r=>r.appendChild(document.createElement('td')));
    }
  }
}

/* ===== í•œê¸€ ì™„ì „ ë¶„í•´ ===== */
function decomposeHangul(ch){
  const base=0xAC00;
  const chos="ã„±ã„²ã„´ã„·ã„¸ã„¹ã…ã…‚ã…ƒã……ã…†ã…‡ã…ˆã…‰ã…Šã…‹ã…Œã…ã…";
  const jungs="ã…ã…ã…‘ã…’ã…“ã…”ã…•ã…–ã…—ã…˜ã…™ã…šã…›ã…œã…ã…ã…Ÿã… ã…¡ã…¢ã…£";
  const jongs=["","ã„±","ã„²","ã„³","ã„´","ã„µ","ã„¶","ã„·","ã„¹","ã„º","ã„»","ã„¼","ã„½","ã„¾","ã„¿","ã…€","ã…","ã…‚","ã…„","ã……","ã…†","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
  const code=ch.charCodeAt(0)-base;
  if(code<0||code>11171) return [ch];
  const cho=Math.floor(code/588);
  const jung=Math.floor((code%588)/28);
  const jong=code%28;
  const arr=[chos[cho], jungs[jung]];
  if(jongs[jong]) arr.push(jongs[jong]);
  return arr;
}

/* ===== ëª¨ìŒ ë„í˜• ìƒì„± (í†µì¼) ===== */
function createVowelShape(){
  const div=document.createElement('div');
  div.className='vowel';
  return div;
}

/* ===== í–‰ ì¶”ê°€ ===== */
async function addRow(name){
  const chars=[...name];
  const parts=[]; chars.forEach(ch=>parts.push(...decomposeHangul(ch)));

  ensureColumns(parts.length);

  const tr=document.createElement('tr');
  const tdName=document.createElement('td'); tdName.textContent=name; tr.appendChild(tdName);

  // í˜„ì¬ í—¤ë” ìˆ˜ë§Œí¼ ë¹ˆ ì¹¸ ë¨¼ì € ìƒì„±
  const numericCols=sheet.querySelector('thead tr').children.length-1;
  for(let i=0;i<numericCols;i++) tr.appendChild(document.createElement('td'));

  sheetBody.appendChild(tr);

  // ì´ë¦„ì¹¸ ì¸í„°ë™ì…˜
  tdName.addEventListener('mouseenter',()=>{
    const c=RING_COLORS[Math.floor(Math.random()*RING_COLORS.length)];
    tdName.style.background=c; tdName.style.color="#000";
  });
  tdName.addEventListener('mouseleave',()=>{
    tdName.style.background="transparent"; tdName.style.color="#000";
  });
  tdName.addEventListener('click',()=>waveRow(tr,80,true));

  // ìŒì†Œ ì±„ìš°ê¸° (ì•ì—ì„œë¶€í„°)
  const tds=[...tr.querySelectorAll('td')].slice(1);
  for(let i=0;i<parts.length && i<tds.length;i++){
    const td=tds[i];
    setTimeout(()=>{
      const c=RING_COLORS[Math.floor(Math.random()*RING_COLORS.length)];
      td.style.background=c;
      if(MAP[parts[i]]){
        const d=document.createElement('div');
        d.className='icon'; d.textContent=MAP[parts[i]];
        td.appendChild(d); setTimeout(()=>d.classList.add('show'),50);
      }else if(/[ã…-ã…£]/.test(parts[i])){
        const v=createVowelShape(); td.appendChild(v); setTimeout(()=>v.classList.add('show'),50);
      }
      setTimeout(()=>td.style.background='transparent',600);
    }, i*180);
  }
  tr.scrollIntoView({behavior:'smooth',block:'end'});
}

/* ===== íŒŒë„ ì• ë‹ˆë©”ì´ì…˜ ===== */
function waveRow(tr, step=100, soft=false){
  const tds=[...tr.querySelectorAll('td')];
  if(tds.length<=1) return;
  const color=RING_COLORS[Math.floor(Math.random()*RING_COLORS.length)];
  const cells=tds.slice(1);
  const colCount=cells.length;
  const startIdx=soft?0:Math.floor(Math.random()*colCount);
  for(let i=0;i<colCount;i++){
    const idx=(startIdx+i)%colCount;
    const td=cells[idx];
    setTimeout(()=>{
      td.style.background=color;
      setTimeout(()=>td.style.background='transparent', soft?280:160);
    }, i*step);
  }
}
function waveSheetFromColumn(startCol=1, step=80){
  const rows=[...sheetBody.querySelectorAll('tr')];
  if(rows.length===0) return;
  const maxCols=sheet.querySelector('thead tr').children.length-1;
  const color=RING_COLORS[Math.floor(Math.random()*RING_COLORS.length)];
  for(let col=startCol; col<=maxCols; col++){
    setTimeout(()=>{
      rows.forEach(r=>{
        const tds=r.querySelectorAll('td');
        if(tds.length>col && Math.random()<0.5){
          const td=tds[col];
          td.style.background=color;
          setTimeout(()=>td.style.background='transparent', 150+Math.random()*150);
        }
      });
    }, (col-startCol)*step);
  }
}

/* ===== ìŒì„± ì¸ì‹ (ì´ë¦„ ê°ì§€) ===== */
const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
let recog;
function startSR(){
  if(!SR){ console.warn('SpeechRecognition ë¯¸ì§€ì›'); return; }
  recog=new SR();
  recog.lang='ko-KR'; recog.continuous=true; recog.interimResults=true;
  recog.onresult=(e)=>{
    for(let i=e.resultIndex;i<e.results.length;i++){
      const res=e.results[i]; if(!res.isFinal) continue;
      const raw=res[0].transcript.trim();
      const text=raw.replace(/\s+/g,'');
      const rx=/([ê°€-í£]{1,6})(?:ì´|ê°€|ë¥¼|ì„|ì€|ëŠ”)?(ì•„|ì•¼)/g;
      let m, names=[];
      while((m=rx.exec(text))!==null){ if(m[1]) names.push(m[1]); }
      names.forEach(n=>addRow(n));
    }
  };
  recog.onerror=e=>console.warn('speech error', e.error);
  recog.onend=()=>{ try{recog.start();}catch(_){ /* iOS ë“± ì¬ì‹œì‘ ì œí•œ ì‹œ ë¬´ì‹œ */ } };
  recog.start();
}

/* ===== ë§ˆì´í¬ ë¶„ì„ (ì†ŒìŒ ë°”ë‹¥ ìë™ ìº˜ë¦¬ë¸Œë ˆì´ì…˜ + íŒŒë„ íŠ¸ë¦¬ê±°) ===== */
let audioCtx, analyser, timeData, micStream;
let noiseFloor=0.02, lastTrigger=0;

function rmsFromTimeData(buf){
  let sum=0;
  for(let i=0;i<buf.length;i++){ const v=(buf[i]-128)/128; sum+=v*v; }
  return Math.sqrt(sum/buf.length);
}

async function setupMic(){
  micStream = await navigator.mediaDevices.getUserMedia({audio:true});
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  const source = audioCtx.createMediaStreamSource(micStream);
  analyser = new AnalyserNode(audioCtx,{fftSize:1024, smoothingTimeConstant:0.85});
  source.connect(analyser);
  timeData = new Uint8Array(analyser.fftSize);

  // 1.5ì´ˆ ìº˜ë¦¬ë¸Œë ˆì´ì…˜
  const samples=[];
  const start=performance.now();
  hint.style.display='block';
  function collect(){
    analyser.getByteTimeDomainData(timeData);
    samples.push(rmsFromTimeData(timeData));
    if(performance.now()-start<1500){ requestAnimationFrame(collect); }
    else{
      samples.sort((a,b)=>a-b);
      const mid=samples[Math.floor(samples.length*0.5)]||0.02;
      noiseFloor=Math.max(0.015, Math.min(0.08, mid));
      hint.textContent='âœ… ìŒì„± ë°˜ì‘ í™œì„±í™”ë¨';
      setTimeout(()=>{hint.style.display='none'}, 1200);
      animateSound();
    }
  }
  collect();
}

function animateSound(){
  analyser.getByteTimeDomainData(timeData);
  const rms=rmsFromTimeData(timeData);
  const now=performance.now();
  const threshold=noiseFloor+0.035;
  const minGap=140; // ms

  if(rms>threshold && now-lastTrigger>minGap){
    lastTrigger=now;
    const headerCount=sheet.querySelector('thead tr').children.length;
    const maxCols=Math.max(1, headerCount-1);
    const startCol=1+Math.floor(Math.random()*maxCols);
    const speed=70+Math.floor((rms-threshold)*1500);
    waveSheetFromColumn(startCol, speed);
  }
  requestAnimationFrame(animateSound);
}

/* ===== ì´ˆê¸°í™” & ë²„íŠ¼ ===== */
initSheetColumns(MAX_COLS); // 1~18 ì—´ ë¯¸ë¦¬ ìƒì„±

document.getElementById('startBtn').addEventListener('click',async()=>{
  try{
    await setupMic();
    startSR();
  }catch(e){
    alert('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
    console.error(e);
  }
});
document.getElementById('printBtn').addEventListener('click',()=>window.print());
</script>

</body>
</html>
